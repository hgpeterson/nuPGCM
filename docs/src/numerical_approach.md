# Numerical Approach

In this section, we describe the numerical scheme used in the $\nu$PGCM to solve the nondimensional PG equations~\eqref{eq:inversion-nd}--\eqref{eq:evolution-nd}.
We discretize the domain using an unstructured mesh of tetrahedra, allowing considerable geometrical flexibility at the cost of requiring a more sophisticated numerical method than standard finite differences on a structured grid.
The numerical solution satisfies the weak Galerkin form of the equations and lives in a specially chosen finite element space to guarantee stability.
To obtain smooth solutions, we must artificially increase the aspect ratio $\alpha$, introducing diffusion in the hydrostatic equation.
The matrix equations for the PG inversion and evolution are solved separately using iterative solvers.
We use Strang splitting to handle advection and diffusion as separate partial steps in the evolution equation.

## Weak formulation

To derive the finite element formulation of the model equations, we first define the function spaces in which we would like our solutions to live.
These spaces need not specify any Neumann conditions such as in~\eqref{eq:u_bc_sfc}, \eqref{eq:b_bc_bot}, and~\eqref{eq:b_bc_sfc}, as those will be taken care of by boundary integrals in the weak formulation, as we will see below.
The velocity, pressure, and buoyancy spaces are then:
```math
\begin{aligned}
    \mathcal{U} &\equiv \Big\{ \vec{u} \in [H^1(\mathcal{D})]^3 : \vec{u} = 0 \; \text{on} \; \Gamma_\mathrm{B} \; \text{and} \; u_i n_i = 0 \; \text{on} \; \Gamma_\mathrm{S} \Big\},\\
    \mathcal{P} &\equiv \Big\{ p \in L^2(\mathcal{D}) : \int_\mathcal{D} p \, \text{d}\vec{x} = 0 \Big\},\\
   \mathcal{B} &\equiv L^2(\mathcal{D}) \quad \text{or} \quad \mathcal{B} \equiv \Big\{ b \in L^2(\mathcal{D}) : b = b_0 \; \text{on} \; \Gamma_{\mathrm{S}} \Big\},
\end{aligned}
```
respectively, where the buoyancy space depends on whether the Dirichlet or Neumann condition is chosen in~\eqref{eq:b_bc_sfc}.
Here, $[H^1(\mathcal{D})]^3$ refers to the Sobolev space of all three-component vector functions that satisfy
```math
\lVert \vec{u} \rVert_{H^1}^2 = \int_\mathcal{D} \left( u^2 + v^2 + w^2 + |\nabla u|^2 + |\nabla v|^2 + |\nabla w|^2 \right) \, \text{d}\vec{x}  < \infty,
```
and $L^2(\mathcal{D})$ refers to the Lebesgue space of all functions that are square integrable, i.e.,
```math
\lVert p \rVert_{L^2}^2 = \int_\mathcal{D} p^2 \, \text{d}\vec{x} < \infty.
```
Without the integral constraint in $\mathcal{P}$, the pressure may only be determined up to an additive constant.

The weak form of the PG inversion is obtained by dotting equations~\eqref{eq:inversion-nd} and~\eqref{eq:continuity-nd} with test functions $(\vec{v}, q) \in \mathcal{U} \times \mathcal{P}$, integrating over the domain, and performing integration by parts on the divergence of the strain rate, yielding
```math
\int_\mathcal{D} \left[ (f \vec{z} \times \vec{u}) \cdot \vec{v} 
    + \nabla p \cdot \vec{v}  
    + (\nabla \cdot \vec{u}) q 
    + 2 \alpha^2 \varepsilon^2 \nu \sigma(\vec{u}) \odot \sigma(\vec{v}) \right] \,\text{d}\vec{x}  
= \int_\mathcal{D} \alpha^{-1} b \vec{z} \cdot \vec{v} \,\text{d}\vec{x} 
    + \alpha \int_{\Gamma_\mathrm{S}} \vec{\tau} \cdot \vec{v}_\perp \,\text{d} \vec{x}.
```
This is known as a saddle-point problem (notice that the pressure $p$ never multiplies its test function $q$).
As we will see in the next section, this limits the discrete spaces on which we may stably represent the solution.
Following the same steps for the buoyancy equation~\eqref{eq:evolution-nd}, this time multiplying by a test function $c \in \mathcal{B}$, yields the weak formulation
\begin{equation}\label{eq:evolution-weak-form}
     \prettyint{\mathcal{D}}{}{\left[ \pder{b}{t} c + u_i \pder{b}{x_i} c + \theta \kappa \pder{b}{x_i} \pder{c}{x_i} \right]}{\vec{x}} = \theta \prettyint{\Gamma_\mathrm{B}}{}{\mathcal{G} c}{\vec{x}} + \theta \prettyint{\Gamma_\mathrm{S}}{}{\mathcal{F} c}{\vec{x}},
\end{equation}
where $\theta = \alpha^2 \varepsilon^2 / \mu \varrho$.
In the Dirichlet boundary condition case, the last integral over $\Gamma_\mathrm{S}$ is removed .

## Finite element discretization

To solve equations~\eqref{eq:inversion-weak-form} and~\eqref{eq:evolution-weak-form} numerically, we tesselate the domain into a mesh $\mathcal{T}_h$ of finite pieces (or ``elements'') with characteristic length scale $h$.
In two dimensional space, each element $T_k \in \mathcal{T}_h$ is a triangle whereas in three dimensions we use tetrahedra (Fig.~\ref{fig:mesh}).
In general, the quality of the mesh can have a significant impact on the accuracy of the solution.
We use meshes generated by Gmsh \citep{geuzaine_gmsh_2009}, although there are many other meshing software packages available. 
We here show results for a parabolic bowl with
\begin{align}
    % \mathcal{D} &= \Big\{ \vec{x} \in \mathbb{R}^3 : -\alpha (1 - x_1^2 - x_2^2) \le x_3 \le 0 \Big\}, \\
    \Gamma_\mathrm{B} &= \Big\{ \vec{x} \in \mathbb{R}^3 : x_1^2 + x_2^2 \le 1 \; \mathrm{and} \; x_3 = -\alpha (1 - x_1^2 - x_2^2) \Big\},\\
    \Gamma_\mathrm{S} &= \Big\{ \vec{x} \in \mathbb{R}^3 : x_1^2 + x_2^2 \le 1 \; \mathrm{and} \; x_3 = 0 \Big\},
\end{align}
though arbitrary geometries are possible with this method.
In general, one now defines a subspace of the full solution space that can be spanned by a finite number of basis functions defined on the mesh, converting the continuous form of the weak formulation~\eqref{eq:U-space}--\eqref{eq:evolution-weak-form} into a discrete problem.
A simple and common choice for this subspace is the set of continuous, piecewise-polynomial functions of degree $n$ over the elements, $P_n(\mathcal{T}_h)$.
Denoting each node in the mesh by $\vec{x}_i$, one can create a set of basis functions for this space $\{\varphi_i\}$ that satisfy
\begin{equation}\label{eq:Kronecker}
    \varphi_i(\vec{x}_j) = \delta_{ij},
\end{equation}
where $\delta_{ij}$ is the Kronecker delta.
For the linear space $P_1(\mathcal{T}_h)$, the element vertices supply enough nodes to span the space (orange crosses in Fig.~\ref{fig:mesh}a,c), but for higher-order spaces, more nodes are needed.

As discussed above, this formulation of the PG inversion is equivalent to the Stokes problem with rotation, allowing us to employ a standard mixed finite element scheme. 
Although not all discrete subspaces are stable for saddle-point problems such as~\eqref{eq:inversion-weak-form}, if they satisfy the so-called LBB condition, a unique solution that depends continuously on the forcing exists \citep[e.g.][]{hughes_finite_1987,elman_finite_2014}.
It is possible to choose a finite element basis that does not satisfy the LBB condition, but ad hoc stabilization schemes are necessary \citep[e.g.,][]{danilov_finite-element_2004}.
We instead choose the simple and accurate $P_2$--$P_1$ basis that is known to satisfy the LBB condition.
In this basis, the velocities are quadratic while the pressure is linear, so that  the discrete subspaces defined over the mesh are
\begin{equation}\label{eq:Uh-Ph-spaces}
    \mathcal{U}_h \equiv [P_2(\mathcal{T}_h)]^3 \cap \mathcal{U} \quad \mathrm{and} \quad \mathcal{P}_h \equiv P_1(\mathcal{T}_h) \cap \mathcal{P}.
\end{equation}
The degrees of freedom for the velocity components therefore exist on both the midpoints and vertices of the elements while those of the pressure are just on the vertices (Fig.~\ref{fig:mesh}a,c).
The added degrees of freedom from using second-order elements increases the computational demand of the PG inversion, but, as we will see in the next section, the convergence rate is rapid enough that resolution constraints are not as high.
While not needed for stability, we represent buoyancy with quadratic, rather than linear, polynomials to ensure high accuracy:
\begin{equation}\label{eq:Bh-space}
    \mathcal{B}_h \equiv P_2(\mathcal{T}_h) \cap \mathcal{B}.
\end{equation}

\begin{figure*}
    \centering
    \includegraphics[width=27pc]{mesh.pdf}
    \caption{Meshes $\mathcal{T}_h$ of (a) two- and (b) three-dimensional basin domains and sketches of (c) triangular and (d) tetrahedral finite elements $T_k \in \mathcal{T}_h$.
    The meshes are generated for a parabolic basin with $\alpha = 1/2$ and a characteristic resolution of $h = 1/20$.
    In the mixed finite element method described in section~\ref{ss:FEM}, the pressure degrees of freedom $\mathbf{p}_j^k$ correspond to values on the vertices of each element while the velocity and buoyancy degrees of freedom $(\mathbf{u}_i)_j^k$ and $\mathbf{b}_j^k$ exist on both the vertices and midpoints.
    The superscripts indicate that these are the degrees of freedom on the local element $T_k$.}
    \label{fig:mesh}
\end{figure*}

With the discrete subspaces defined in~\eqref{eq:Uh-Ph-spaces} and~\eqref{eq:Bh-space}, we can assemble the matrices needed to compute the PG inversion and evolve buoyancy in time.
If $\{ (\varphi_i)_j \}$, $\{ \psi_j \}$, and $\{ \varphi_i \}$ are the sets of basis vectors for $\mathcal{U}_h$, $\mathcal{P}_h$, and $\mathcal{B}_h$, respectively, then the solution to the weak formulation of the PG equations can be represented as linear combinations of these functions:
\begin{equation}
    (u_i)_h(\vec{x}) = (\mathbf{u}_i)_j (\varphi_i)_j(\vec{x}), \quad p_h(\vec{x}) = \mathbf{p}_j \psi_j(\vec{x}), \quad b_h(\vec{x}) = \mathbf{b}_j \varphi_j(\vec{x}),
\end{equation}
with $\mathbf{u}_i$, $\mathbf{p}$, and $\mathbf{b}$ being the vectors of projection coefficients.
Note that, because the underlying basis vectors are continuously defined over the entire domain, so are the solutions.
This is in contrast to typical finite difference methods where the solution is only defined on the grid.
Conveniently, because of the choice of nodal basis functions defined by the property~\eqref{eq:Kronecker}, the projection coefficients are equal to the values of these functions on the nodes of the mesh:
\begin{equation}
    (u_i)_h(\vec{x}_k) = (\mathbf{u}_i)_k, \quad p_h(\vec{x}_k) = \mathbf{p}_k, \quad b_h(\vec{x}_k) = \mathbf{b}_k.
\end{equation}

Given the buoyancy coefficients $\mathbf{b}$, the coefficients for the velocity and pressure $\mathbf{x} = [\mathbf{u_1}, \mathbf{u}_2, \mathbf{u}_3, \mathbf{p}]^T$ can be determined by solving the matrix equation
\begin{equation}\label{eq:inversion-matrix-form}
    \hat{\mathbf{K}} \mathbf{x} = \hat{\mathbf{M}} \mathbf{b} + \mathbf{s},
\end{equation}
where $\hat{\mathbf{K}}$, $\hat{\mathbf{M}}$, and $\mathbf{s}$ are computed by integrating the weak formulation of the inversion~\eqref{eq:inversion-weak-form} for each basis function.
For instance,
\begin{equation}
    \hat{\mathbf{M}}_{ij} = \prettyint{\mathcal{D}}{}{\alpha^{-1} \varphi_j z_k (\varphi_k)_i}{\vec{x}} \quad \text{and} \quad \mathbf{s}_i = \prettyint{\mathcal{D}}{}{\tau_{kj}n_j(\varphi_k)_i}{\vec{x}}.
\end{equation}
We use the Julia \citep{bezanson_julia_2017} package Gridap.jl to automate this step \citep{badia_gridap_2020}.
A high-resolution three-dimensional inversion can easily contain millions of tetrahedra, making a direct solve of the matrix equation~\eqref{eq:inversion-matrix-form} impractical.
Instead, we load $\hat{\mathbf{K}}$ onto a GPU using CUDA.jl \citep{besard_effective_2019} and solve the problem iteratively using Krylov.jl's \citep{montoison_krylovjl_2023} implementation of the generalized minimum residual method (GMRES).
In the following section, evaluate the error of this method.

## Convergence rates for the PG inversion

As a test case to validate the accuracy and convergence rate of the numerical inversion, we solve for $(\vec{u}_h, p_h)$ given flat isopycnals in the parabolic bowl geometry: $b = \alpha^{-1} x_3$.
The exact solution is
\begin{equation}\label{eq:true-sol}
    \vec{u} = 0 \quad \mathrm{and} \quad p = \frac{x_3^2}{2 \alpha^2} - C,
\end{equation}
where $C$ is a constant to satisfy the integral constraint equal to~4/35 for the two-dimensional bowl and~1/12 for the three-dimensional bowl.
Deviations from this exact solution result from inaccuracies in representing horizontal pressure gradients, making it a useful test case. 
Since isopycnals are flat throughout much of the ocean, these pressure gradient errors can be detrimental for ocean models if they are not small relative to full flow. 
Such errors are ubiquitous in terrain-following coordinate models \citep[e.g.,][]{haney_pressure_1991}, prohibiting their use for global-scale problems.
As we will see below, these errors are relatively modest in our model and, importantly, their magnitude rapidly decreases with increasing resolution.

From finite element theory \citep[e.g.,][]{hughes_finite_1987, elman_finite_2014}, the error in the so-called ``energy norm'' for the $P_2$--$P_1$ method scales as
\begin{equation}\label{eq:energy-norm-scaling}
    \lVert \vec{u}_h \rVert_{H^1} + \lVert p - p_h \rVert_{L^2} \sim O(h^2),
\end{equation}
where, again, $h$ is the characteristic mesh resolution.
This is indeed the case for a range of parameters in both two- and three-dimensional inversions (Fig.~\ref{fig:convergence}a,b).
We also find that this error scales roughly like $O(\alpha^{-2}\varepsilon^{-2})$.
This follows from the fact that the BL scale is proportional to $\alpha \varepsilon$ so that the effective resolution with respect to the BL $h_\mathrm{eff} \sim h/(\alpha\varepsilon)$.
Since the error tends to be concentrated near the boundary for this problem, it is not a surprise that the energy norm scales like $h_\mathrm{eff}^2$.

\begin{figure*}
    \centering
    \includegraphics[width=33pc]{convergence.pdf}
    \caption{Convergence rates of the PG inversion with respect to resolution $h$, Ekman number $\varepsilon$, and aspect ratio $\alpha$ for the case of flat isopycnals in a parabolic bowl basin (see Fig.~\ref{fig:mesh}a,b) with true solution~\eqref{eq:true-sol}.
    (a) and (c) are for two-dimensional geometry and (b) and (d) show results for the three-dimensional inversion.
    The error scales like $h^2$ in the energy norm [(a) and (b)] and $h^3$ in the max norm [(c) and (d)].
    }
    \label{fig:convergence}
\end{figure*}

While there is not a general theory for the scaling of the maximum error $\lVert \vec{u}_h \rVert_{L^\infty} \equiv \sup_\mathcal{D} |\vec{u}_h|$, its value is more interpretable than that of the energy norm.
We find that, for this particular test with flat isopycnals, the error empirically scales with $h^3$ (Fig.~\ref{fig:convergence}c,d).
This rapid convergence rate in the maximum pressure gradient error is promising for the accuracy of large-scale ocean circulation simulated by this model.
Next, we will couple the inversion to the evolution equation to simulate time-dependent flow.

## Timestepping

\begin{figure}
    \centering
    \includegraphics[width=19pc]{timestep.pdf}
    \caption{Flow chart of a single Strang-split timestep from $t^n$ to $t^{n+1} = t^n + \Delta t$ in a simulation (see section~\ref{ss:timestepping} for details).
    ``Invert'' refers to solving the matrix equation~\eqref{eq:inversion-matrix-form} for the PG inversion.
    The half- and forward advection steps are described in equations~\eqref{eq:half-step} and~\eqref{eq:forward-step}, respectively, and the $\Delta t /2$ diffusion steps follow equation~\eqref{eq:diffusion-step}.
    }
    \label{fig:timestep}
\end{figure}

Once the solution is projected onto the discrete finite element space described above, the weak form of the buoyancy evolution~\eqref{eq:evolution-weak-form} becomes
\begin{equation}
    \mathbf{M} \pder{\mathbf{b}}{t} + F(\mathbf{u}_i, \mathbf{b}) + \theta \mathbf{K} \mathbf{b} = \theta \mathbf{f},
\end{equation}
where
\begin{equation}
    \mathbf{M}_{ij} = \prettyint{\mathcal{D}}{}{\varphi_i \varphi_j}{\vec{x}} \quad \mathrm{and} \quad \mathbf{K}_{ij} = \prettyint{\mathcal{D}}{}{\kappa \pder{\varphi_{i\vphantom{j}}}{x_k} \pder{\varphi_j}{x_k}}{\vec{x}},
\end{equation}
are known as the ``mass'' and ``stiffness'' matrices in the finite element literature and the vector $\mathbf{f}$ is due to the forcing terms on the right-hand side of~\eqref{eq:evolution-weak-form}.
The non-linear advection term takes the form,
\begin{equation}
    F(\mathbf{u}_i, \mathbf{b})_j =  (\mathbf{u}_i)_k \mathbf{b}_l \prettyint{\mathcal{D}}{}{(\varphi_i)_k \pder{\varphi_l}{x_i} \varphi_j}{\vec{x}},
\end{equation}
which must be explicitly re-computed as the solution evolves. 

To simplify the treatment of both advection and diffusion, we employ Strang splitting \citep{strang_construction_1968} to handle each separately .
Specifically, we split each timestep into (1) a half-step of diffusion, (2) a full-step of advection, and (3) a final half-step of diffusion (Fig.~\ref{fig:timestep}).
For advection, we use a second-order explicit Runge--Kutta step (also known as the midpoint method):
\begin{align}
    \text{Step 1:} &\quad \text{Solve \eqref{eq:inversion-matrix-form} for} \; \mathbf{u}^n \; \text{given} \; \mathbf{b}^n,\\
    \text{Step 2:} &\quad \mathbf{b}^{n + \frac12}_* = \mathbf{b}^n - \frac{\Delta t}{2} \mathbf{M}^{-1} F(\mathbf{u}_i^n, \mathbf{b}^n),\label{eq:half-step}\\
    \text{Step 3:} &\quad \text{Solve \eqref{eq:inversion-matrix-form} for} \; (\mathbf{u}_i)^{n+\frac12}_* \; \text{given} \; \mathbf{b}^{n+\frac12}_*,\\
    \text{Step 4:} &\quad\, \mathbf{b}^{n+1}_* = \mathbf{b}^n - \Delta t \mathbf{M}^{-1} F\left( (\mathbf{u}_i)^{n + \frac12}_*, \mathbf{b}^{n+\frac12}_*\right),\label{eq:forward-step}
\end{align}
where $\Delta t$ is the step size.
The superscripts are a short-hand for $\mathbf{b}^n = \mathbf{b}(t^n)$ where $t^n = n\Delta t$ with $n = 0, 1, 2, \ldots$ and the the subscript $_*$ indicates that only an advection step has been performed.
The matrix $\mathbf{M}^{-1}$ is not computed explicitly, but instead the linear system is iteratively solved on a GPU using the conjugate gradient (CG) method.
Using a left preconditioner of $(\diag \mathbf{M})^{-1}$, this approach is extremely efficient, typically converging to a reasonable tolerance in less than 10 iterations.
Note that this second-order method requires two updates of the velocity field (steps 1 and 3).
For the diffusion half-steps, we use the second-order accurate, semi-implicit Crank--Nicolson method:
\begin{equation}\label{eq:diffusion-step}
    \left(\mathbf{M} + \theta \frac{\Delta t}{4} \mathbf{K} \right) \mathbf{b}^{n+1} = \left(\mathbf{M} - \theta \frac{\Delta t}{4} \mathbf{K} \right) \mathbf{b}^{n+1}_* + \theta \Delta t \mathbf{f},
\end{equation}
We again solve this linear system using the CG method preconditioned by the inverse of the diagonal of the matrix on the left-hand side.

A key advantage of solving the PG equations as opposed to the full Boussinesq system is that they filter out fast-timescale dynamics, allowing for large timesteps.
For the results showcased in section~\ref{s:results}, we use a uniform timestep of $\Delta t = 0.1$, which translates to a dimensional time of about $0.1 / (\Omega \varrho) \approx 100$~days.
This timestep, which is orders of magnitude larger that that of most global ocean models, enables us to relatively cheaply simulate large-scale ocean dynamics over long timescales. 
The basin simulations in the next section are run to a nondimensional time of $t = 25$ or about~80 years, with each taking only about~16 hours to complete on a single compute node with an H100 gpu.
With some performance optimizations and parallelization, the $\nu$PGCM could therefore be used to investigate the millennial-timescale dynamics of the overturning circulation. 